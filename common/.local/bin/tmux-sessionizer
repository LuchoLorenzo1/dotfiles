#!/usr/bin/env bash

set -euo pipefail

directories_file="$HOME/.local/share/sessionizer-folders"

expand_tilde() {
    if [[ $1 == "~"* ]]; then
        printf '%s\n' "${1/#\~/$HOME}"
    else
        printf '%s\n' "$1"
    fi
}

if [[ $# -eq 1 ]]; then
    selected=$(expand_tilde "$1")
else
    if [[ ! -f $directories_file ]]; then
        printf 'sessionizer: missing %s\n' "$directories_file" >&2
        exit 1
    fi

    candidates=()
    while IFS= read -r line || [[ -n $line ]]; do
        [[ -z $line || ${line:0:1} == "#" ]] && continue
        dir=$(expand_tilde "$line")
        [[ -d $dir ]] || continue
        while IFS= read -r sub; do
            candidates+=("$sub")
        done < <(find "$dir" -mindepth 1 -maxdepth 1 -type d)
    done < "$directories_file"

    if [[ ${#candidates[@]} -eq 0 ]]; then
        exit 0
    fi

    selected=$(printf '%s\n' "${candidates[@]}" | fzf)
fi

if [[ -z ${selected:-} ]]; then
    exit 0
fi

selected_name=$(basename "$selected" | tr . _)

created=0
if ! tmux has-session -t "$selected_name" 2>/dev/null; then
    tmux new-session -ds "$selected_name" -c "$selected"
    created=1
fi

if [[ $created -eq 1 ]]; then
    tmux send-keys -t "$selected_name" vifm ' ' "$selected" Enter
    tmux neww -c "$selected" -t "$selected_name" nvim .
    tmux neww -c "$selected" -t "$selected_name"
    tmux neww -c "$selected" -t "$selected_name" claude
    tmux select-window -t "$selected_name":2
fi

if [[ -z ${TMUX:-} ]]; then
    tmux attach-session -t "$selected_name"
else
    tmux switch-client -t "$selected_name"
fi
